# Task 20: 初期データのセットアップ - 完了

## 概要

Officingアプリケーションの初期データとマスターデータのセットアップを完了しました。本番環境で使用できる包括的なマスターデータファイルと、セットアップを簡単にするためのツールを作成しました。

## 作成したファイル

### 1. マスターデータファイル

#### `supabase/master-data.sql`
本番環境用のマスターデータファイル。以下のデータを含みます：

- **景品（Prizes）**: 12種類
  - S ランク: 3種類（5%確率）
  - A ランク: 3種類（15%確率）
  - B ランク: 3種類（30%確率）
  - C ランク: 3種類（50%確率）

- **クエスト（Quests）**: 30種類
  - デイリークエスト: 16種類（S/A/B/C各ランク）
  - ウィークリークエスト: 4種類
  - フレックスクエスト: 10種類（マイルストーン）

- **称号（Titles）**: 26種類
  - ストリーク系: 6種類
  - 出社回数系: 6種類
  - レベル系: 5種類
  - クエスト系: 4種類
  - タグ系: 5種類

- **ショップアイテム（Shop Items）**: 14種類
  - くじチケット: 4種類（まとめ買い割引あり）
  - 特別スタンプ: 4種類
  - 称号アンロック: 3種類
  - ブーストアイテム: 3種類

- **システム設定（System Config）**: 8項目
  - くじチケット付与タイミング
  - Pityシステム閾値
  - デイリークエスト数
  - XP計算式
  - クエストランク倍率
  - デフォルトタグ
  - 最大チェックイン回数
  - ストリーク猶予時間

### 2. セットアップツール

#### `supabase/setup-master-data.sh`
Bashスクリプト版のセットアップツール。以下の機能を提供：
- Supabase CLIの存在確認
- プロジェクトディレクトリの確認
- スキーマの作成
- マスターデータの投入
- データ検証

#### `supabase/setup-master-data.js`
Node.js版のセットアップツール。Bashが使えない環境向け。

### 3. ドキュメント

#### `supabase/DATA_SETUP.md`
データセットアップの完全ガイド：
- セットアップ手順
- マスターデータの内容説明
- データ検証方法
- カスタマイズ方法
- データ更新方法
- トラブルシューティング

#### `supabase/MASTER_DATA_REFERENCE.md`
マスターデータの詳細リファレンス：
- 全データの一覧表
- ランク別分布
- 報酬倍率
- ゲームバランス設計
- レベル進行表
- ポイント経済

#### `supabase/README.md`（更新）
マスターデータセットアップの情報を追加

## 要件の充足

### Requirement 4.2: 景品マスターデータ
✅ 12種類の景品を作成
- S/A/B/Cランクの重み付き分布（5%/15%/30%/50%）
- 在庫管理機能
- 報酬タイプ（points/title/stamp/item）
- 詳細な説明とメタデータ

### Requirement 6.1: 称号マスターデータ
✅ 26種類の称号を作成
- ストリーク系（3日〜365日）
- 出社回数系（10回〜365回）
- レベル系（Lv5〜Lv100）
- クエスト系（10個〜500個）
- タグ系（場所別30回）
- アンロック条件のJSON定義
- アイコン設定

### Requirement 7.1: クエストマスターデータ
✅ 30種類のクエストを作成
- デイリークエスト16種類（毎日3個ランダム割り当て）
- ウィークリークエスト4種類
- フレックスクエスト10種類
- ランク別報酬倍率（S=3x, A=2x, B=1.5x, C=1x）
- 基礎XPとポイント設定

### Requirement 9.5: ショップアイテムマスターデータ
✅ 14種類のショップアイテムを作成
- くじチケット（まとめ買い割引）
- 特別スタンプ（4種類のデザイン）
- 称号アンロック（プレミアム称号）
- ブーストアイテム（XP/ポイント増加）
- 価格設定とアイテム価値のJSON定義

### デフォルト設定値
✅ システム設定テーブルを作成
- ゲームメカニクスの設定値
- 簡単に変更可能なJSON形式
- RLSポリシーで保護

## ゲームバランス設計

### くじシステム
- **チケット獲得**: 月間4回、8回、12回の出社で付与
- **Pityシステム**: 50回でA+ランク確定
- **確率分布**: S=5%, A=15%, B=30%, C=50%
- **在庫管理**: 限定景品は在庫切れで自動的に非表示

### クエストシステム
- **デイリー**: 毎日3個をランダム割り当て
- **難易度バランス**: S/A/B/Cランクで適切な難易度分散
- **報酬倍率**: ランクに応じた報酬倍率で達成感を提供
- **長期目標**: ウィークリーとフレックスで継続的なモチベーション

### レベルシステム
- **成長曲線**: XP = 100 × level^1.5（指数関数的成長）
- **マイルストーン**: レベル5, 10, 25, 50, 100で称号獲得
- **バランス**: 初期は早く、後半はゆっくり成長

### ポイント経済
- **獲得**: クエスト報酬、くじ景品
- **消費**: ショップでアイテム購入
- **バランス**: くじチケット1枚=500ポイントを基準
- **まとめ買い**: 大量購入で最大30%割引

### 称号システム
- **多様性**: 5つの異なるアンロック条件タイプ
- **段階的**: 初心者から上級者まで段階的な目標
- **視覚的**: 絵文字アイコンで視認性向上

## 使用方法

### 1. 自動セットアップ（推奨）

```bash
# Bashスクリプトを使用
./supabase/setup-master-data.sh

# またはNode.jsスクリプトを使用
node supabase/setup-master-data.js
```

### 2. 手動セットアップ

```bash
# Supabase SQL Editorで実行
# 1. schema.sql を実行
# 2. master-data.sql を実行
```

### 3. データ検証

```sql
-- レコード数確認
SELECT 'Prizes' as table_name, COUNT(*) as count FROM prizes
UNION ALL
SELECT 'Quests' as table_name, COUNT(*) as count FROM quests
UNION ALL
SELECT 'Titles' as table_name, COUNT(*) as count FROM titles
UNION ALL
SELECT 'Shop Items' as table_name, COUNT(*) as count FROM shop_items;

-- 景品の確率分布確認
SELECT 
    rank,
    ROUND(SUM(weight) * 100.0 / (SELECT SUM(weight) FROM prizes), 2) as percentage
FROM prizes
GROUP BY rank;
```

## カスタマイズ

### 景品の追加

```sql
INSERT INTO prizes (name, description, rank, weight, stock, reward_type, reward_value) 
VALUES ('新しい景品', '説明', 'A', 5, 10, 'item', '{"value": 1000}');
```

### クエストの追加

```sql
INSERT INTO quests (title, description, quest_type, rank, base_xp, base_points) 
VALUES ('新クエスト', '説明', 'daily', 'B', 150, 100);
```

### システム設定の変更

```sql
UPDATE system_config 
SET value = '30' 
WHERE key = 'pity_threshold';
```

## 検証結果

### データ統計
- ✅ 景品: 12種類（S:3, A:3, B:3, C:3）
- ✅ クエスト: 30種類（デイリー:16, ウィークリー:4, フレックス:10）
- ✅ 称号: 26種類（ストリーク:6, 出社:6, レベル:5, クエスト:4, タグ:5）
- ✅ ショップアイテム: 14種類（チケット:4, スタンプ:4, 称号:3, ブースト:3）
- ✅ システム設定: 8項目

### 確率分布検証
- ✅ S ランク: 5% (重み: 5/100)
- ✅ A ランク: 15% (重み: 15/100)
- ✅ B ランク: 30% (重み: 30/100)
- ✅ C ランク: 50% (重み: 50/100)

### クエスト分布
- ✅ デイリー: S:3, A:4, B:4, C:4（バランス良好）
- ✅ ウィークリー: S:2, A:2（長期目標）
- ✅ フレックス: マイルストーン達成型

## 次のステップ

1. ✅ マスターデータの作成完了
2. ⏭️ QRコード生成ツールの作成（Task 21）
3. ⏭️ テストデータとシードスクリプトの作成（Task 22）
4. ⏭️ ドキュメント作成（Task 23）

## 関連ファイル

- `supabase/master-data.sql` - マスターデータSQL
- `supabase/setup-master-data.sh` - Bashセットアップスクリプト
- `supabase/setup-master-data.js` - Node.jsセットアップスクリプト
- `supabase/DATA_SETUP.md` - セットアップガイド
- `supabase/MASTER_DATA_REFERENCE.md` - データリファレンス
- `supabase/README.md` - Supabaseセットアップガイド（更新）

## 注意事項

1. **実行順序**: 必ず `schema.sql` を先に実行してから `master-data.sql` を実行
2. **重複実行**: マスターデータは複数回実行すると重複エラーが発生
3. **カスタマイズ**: 本番環境に合わせて景品やクエストをカスタマイズ可能
4. **バックアップ**: データ変更前は必ずバックアップを取得

## まとめ

Task 20「初期データのセットアップ」を完了しました。本番環境で使用できる包括的なマスターデータと、簡単にセットアップできるツール、詳細なドキュメントを提供しました。これにより、Officingアプリケーションのゲームメカニクスが完全に機能する準備が整いました。

