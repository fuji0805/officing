<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <title>PWA Test - Officing</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 2rem;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #4F46E5;
            margin-bottom: 1rem;
        }
        
        .section {
            margin: 2rem 0;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 4px;
        }
        
        .section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
        }
        
        .status-icon {
            font-size: 1.5rem;
        }
        
        .status-text {
            flex: 1;
        }
        
        .status-value {
            font-weight: 600;
            color: #4F46E5;
        }
        
        .btn {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        
        .btn:hover {
            background: #4338CA;
        }
        
        .btn-secondary {
            background: #6B7280;
        }
        
        .btn-secondary:hover {
            background: #4B5563;
        }
        
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .log-entry {
            margin: 0.25rem 0;
        }
        
        .success { color: #10B981; }
        .error { color: #EF4444; }
        .warning { color: #F59E0B; }
        .info { color: #3B82F6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ PWA Functionality Test</h1>
        <p>„Åì„ÅÆ„Éö„Éº„Ç∏„ÅßPWAÊ©üËÉΩ„Çí„ÉÜ„Çπ„Éà„Åß„Åç„Åæ„Åô„ÄÇ</p>
        
        <!-- Service Worker Status -->
        <div class="section">
            <h2>Service Worker</h2>
            <div class="status">
                <span class="status-icon" id="sw-icon">‚è≥</span>
                <span class="status-text">Status:</span>
                <span class="status-value" id="sw-status">Checking...</span>
            </div>
            <button class="btn" onclick="registerServiceWorker()">Register SW</button>
            <button class="btn btn-secondary" onclick="unregisterServiceWorker()">Unregister SW</button>
            <button class="btn btn-secondary" onclick="updateServiceWorker()">Update SW</button>
        </div>
        
        <!-- Cache Status -->
        <div class="section">
            <h2>Cache</h2>
            <div class="status">
                <span class="status-icon">üíæ</span>
                <span class="status-text">Cached Files:</span>
                <span class="status-value" id="cache-count">0</span>
            </div>
            <button class="btn" onclick="checkCache()">Check Cache</button>
            <button class="btn btn-secondary" onclick="clearCache()">Clear Cache</button>
        </div>
        
        <!-- Network Status -->
        <div class="section">
            <h2>Network</h2>
            <div class="status">
                <span class="status-icon" id="network-icon">üì∂</span>
                <span class="status-text">Status:</span>
                <span class="status-value" id="network-status">Online</span>
            </div>
            <button class="btn" onclick="simulateOffline()">Simulate Offline</button>
            <button class="btn btn-secondary" onclick="simulateOnline()">Simulate Online</button>
        </div>
        
        <!-- Queue Status -->
        <div class="section">
            <h2>Offline Queue</h2>
            <div class="status">
                <span class="status-icon">‚è≥</span>
                <span class="status-text">Queued Items:</span>
                <span class="status-value" id="queue-count">0</span>
            </div>
            <button class="btn" onclick="checkQueue()">Check Queue</button>
            <button class="btn" onclick="syncQueue()">Sync Queue</button>
            <button class="btn btn-secondary" onclick="clearQueue()">Clear Queue</button>
        </div>
        
        <!-- Install Status -->
        <div class="section">
            <h2>PWA Install</h2>
            <div class="status">
                <span class="status-icon" id="install-icon">üì±</span>
                <span class="status-text">Status:</span>
                <span class="status-value" id="install-status">Not Installed</span>
            </div>
            <button class="btn" onclick="showInstallPrompt()">Show Install Prompt</button>
        </div>
        
        <!-- Manifest -->
        <div class="section">
            <h2>Manifest</h2>
            <div class="status">
                <span class="status-icon">üìÑ</span>
                <span class="status-text">Status:</span>
                <span class="status-value" id="manifest-status">Checking...</span>
            </div>
            <button class="btn" onclick="checkManifest()">Check Manifest</button>
        </div>
        
        <!-- Log -->
        <div class="section">
            <h2>Log</h2>
            <div class="log" id="log"></div>
            <button class="btn btn-secondary" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        // Logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Service Worker
        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                log('Service Worker not supported', 'error');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                log('‚úÖ Service Worker registered', 'success');
                updateSWStatus();
            } catch (error) {
                log(`‚ùå SW registration failed: ${error.message}`, 'error');
            }
        }
        
        async function unregisterServiceWorker() {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
                await registration.unregister();
            }
            log('‚úÖ Service Worker unregistered', 'success');
            updateSWStatus();
        }
        
        async function updateServiceWorker() {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
                await registration.update();
            }
            log('‚úÖ Service Worker updated', 'success');
        }
        
        async function updateSWStatus() {
            const registrations = await navigator.serviceWorker.getRegistrations();
            const status = registrations.length > 0 ? 'Registered' : 'Not Registered';
            const icon = registrations.length > 0 ? '‚úÖ' : '‚ùå';
            document.getElementById('sw-status').textContent = status;
            document.getElementById('sw-icon').textContent = icon;
        }
        
        // Cache
        async function checkCache() {
            const cacheNames = await caches.keys();
            log(`Cache keys: ${cacheNames.join(', ')}`, 'info');
            
            let totalFiles = 0;
            for (const cacheName of cacheNames) {
                const cache = await caches.open(cacheName);
                const keys = await cache.keys();
                totalFiles += keys.length;
                log(`  ${cacheName}: ${keys.length} files`, 'info');
            }
            
            document.getElementById('cache-count').textContent = totalFiles;
        }
        
        async function clearCache() {
            const cacheNames = await caches.keys();
            for (const cacheName of cacheNames) {
                await caches.delete(cacheName);
            }
            log('‚úÖ Cache cleared', 'success');
            document.getElementById('cache-count').textContent = '0';
        }
        
        // Network
        function updateNetworkStatus() {
            const isOnline = navigator.onLine;
            const status = isOnline ? 'Online' : 'Offline';
            const icon = isOnline ? 'üì∂' : 'üìµ';
            document.getElementById('network-status').textContent = status;
            document.getElementById('network-icon').textContent = icon;
        }
        
        function simulateOffline() {
            log('‚ö†Ô∏è Simulating offline (use DevTools Network tab)', 'warning');
        }
        
        function simulateOnline() {
            log('‚úÖ Simulating online', 'success');
        }
        
        // Queue
        async function checkQueue() {
            try {
                const db = await openQueueDB();
                const tx = db.transaction('queue', 'readonly');
                const store = tx.objectStore('queue');
                const all = await store.getAll();
                
                document.getElementById('queue-count').textContent = all.length;
                log(`Queue has ${all.length} items`, 'info');
                
                all.forEach((item, i) => {
                    log(`  Item ${i + 1}: ${item.url}`, 'info');
                });
            } catch (error) {
                log(`‚ùå Failed to check queue: ${error.message}`, 'error');
            }
        }
        
        async function syncQueue() {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'SYNC_QUEUE' });
                log('‚úÖ Sync request sent to Service Worker', 'success');
            } else {
                log('‚ùå No Service Worker controller', 'error');
            }
        }
        
        async function clearQueue() {
            try {
                const db = await openQueueDB();
                const tx = db.transaction('queue', 'readwrite');
                const store = tx.objectStore('queue');
                await store.clear();
                
                document.getElementById('queue-count').textContent = '0';
                log('‚úÖ Queue cleared', 'success');
            } catch (error) {
                log(`‚ùå Failed to clear queue: ${error.message}`, 'error');
            }
        }
        
        function openQueueDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('officing-queue', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('queue')) {
                        db.createObjectStore('queue', { keyPath: 'timestamp' });
                    }
                };
            });
        }
        
        // Install
        function showInstallPrompt() {
            log('‚ö†Ô∏è Install prompt can only be shown after beforeinstallprompt event', 'warning');
        }
        
        function updateInstallStatus() {
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches ||
                               window.navigator.standalone === true;
            const status = isInstalled ? 'Installed' : 'Not Installed';
            const icon = isInstalled ? '‚úÖ' : 'üì±';
            document.getElementById('install-status').textContent = status;
            document.getElementById('install-icon').textContent = icon;
        }
        
        // Manifest
        async function checkManifest() {
            try {
                const response = await fetch('/manifest.json');
                const manifest = await response.json();
                log('‚úÖ Manifest loaded', 'success');
                log(`  Name: ${manifest.name}`, 'info');
                log(`  Short Name: ${manifest.short_name}`, 'info');
                log(`  Icons: ${manifest.icons.length}`, 'info');
                document.getElementById('manifest-status').textContent = 'Valid';
            } catch (error) {
                log(`‚ùå Manifest error: ${error.message}`, 'error');
                document.getElementById('manifest-status').textContent = 'Error';
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            log('üöÄ PWA Test Page Loaded', 'success');
            updateSWStatus();
            updateNetworkStatus();
            updateInstallStatus();
            checkManifest();
            checkCache();
            checkQueue();
        });
        
        window.addEventListener('online', () => {
            log('üì∂ Network: Online', 'success');
            updateNetworkStatus();
        });
        
        window.addEventListener('offline', () => {
            log('üìµ Network: Offline', 'warning');
            updateNetworkStatus();
        });
    </script>
</body>
</html>
