<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - Officing</title>
  <link rel="stylesheet" href="./css/main.css">
  <style>
    .dashboard-screen {
      min-height: 100vh;
      background: linear-gradient(135deg, #4F46E5 0%, #4338CA 100%);
      padding: var(--spacing-lg);
    }
    
    .dashboard-container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      text-align: center;
      color: white;
      margin-bottom: var(--spacing-xl);
    }
    
    .dashboard-title {
      font-size: var(--font-size-3xl);
      font-weight: 700;
      margin-bottom: var(--spacing-sm);
    }
    
    .dashboard-card {
      background-color: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-lg);
      margin-bottom: var(--spacing-lg);
    }
    
    .level-display {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg);
      background: linear-gradient(135deg, #EDE9FE 0%, #DDD6FE 100%);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
    }
    
    .level-info {
      flex: 1;
    }
    
    .level-number {
      font-size: var(--font-size-3xl);
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: var(--spacing-xs);
    }
    
    .level-xp {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }
    
    .level-progress {
      flex: 2;
      margin-left: var(--spacing-xl);
    }
    
    .xp-bar-container {
      width: 100%;
      height: 20px;
      background-color: rgba(255, 255, 255, 0.5);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-bottom: var(--spacing-xs);
    }
    
    .xp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4F46E5 0%, #8B5CF6 100%);
      border-radius: var(--radius-full);
      transition: width 1s ease-out;
    }
    
    .xp-text {
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      text-align: right;
    }
    
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    
    .stat-box {
      text-align: center;
      padding: var(--spacing-md);
      background-color: var(--bg-secondary);
      border-radius: var(--radius-md);
    }
    
    .stat-value {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--primary-color);
      display: block;
      margin-bottom: var(--spacing-xs);
    }
    
    .stat-label {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }
    
    .nav-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
    }
    
    .nav-btn {
      padding: var(--spacing-lg);
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
    }
    
    .nav-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
  </style>
</head>
<body>
  <div id="loading" class="loading-screen">
    <div class="spinner"></div>
    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
  
  <div id="app"></div>
  
  <script src="./js/config.js"></script>
  <script src="./js/supabase-client.js"></script>
  <script src="./js/auth.js"></script>
  <script src="./js/level.js"></script>
  <script src="./js/title.js"></script>
  
  <script>
    async function showDashboard() {
      const appDiv = document.getElementById('app');
      
      try {
        // Get user progress
        const progress = await levelManager.getUserProgress();
        
        // Calculate XP for next level
        const xpForNextLevel = levelManager.calculateXPForLevel(progress.level + 1);
        const progressPercent = levelManager.calculateLevelProgress(progress.current_xp, xpForNextLevel);
        
        // Get active title
        const activeTitle = await titleManager.getActiveTitle();
        
        appDiv.innerHTML = `
          <div class="dashboard-screen">
            <div class="dashboard-container">
              <div class="dashboard-header">
                <h1 class="dashboard-title">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
              </div>
              
              <div class="dashboard-card">
                <!-- Level Display -->
                <div class="level-display">
                  <div class="level-info">
                    <div class="level-number">Lv.${progress.level}</div>
                    ${activeTitle ? `<div class="level-xp">ğŸ‘‘ ${activeTitle.name}</div>` : `<div class="level-xp">ãƒ¬ãƒ™ãƒ« ${progress.level}</div>`}
                  </div>
                  <div class="level-progress">
                    <div class="xp-bar-container">
                      <div class="xp-bar-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="xp-text">
                      ${levelManager.formatXP(progress.current_xp)} / ${levelManager.formatXP(xpForNextLevel)} XP (${progressPercent}%)
                    </div>
                  </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="quick-stats">
                  <div class="stat-box">
                    <span class="stat-value">ğŸ’° ${progress.total_points}</span>
                    <span class="stat-label">ãƒã‚¤ãƒ³ãƒˆ</span>
                  </div>
                  <div class="stat-box">
                    <span class="stat-value">ğŸ”¥ ${progress.current_streak}</span>
                    <span class="stat-label">é€£ç¶šå‡ºç¤¾</span>
                  </div>
                  <div class="stat-box">
                    <span class="stat-value">â­ ${progress.current_xp}</span>
                    <span class="stat-label">ç¾åœ¨ã®XP</span>
                  </div>
                </div>
                
                <!-- Navigation -->
                <div class="nav-buttons">
                  <a href="./profile.html" class="nav-btn">
                    ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                  </a>
                  <a href="./quest-demo.html" class="nav-btn">
                    ğŸ“‹ ã‚¯ã‚¨ã‚¹ãƒˆ
                  </a>
                  <a href="./lottery-demo.html" class="nav-btn">
                    ğŸ° ãã˜
                  </a>
                  <a href="./titles-demo.html" class="nav-btn">
                    ğŸ‘‘ ç§°å·
                  </a>
                  <a href="./checkin-success-demo.html" class="nav-btn">
                    âœ… ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³
                  </a>
                </div>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Dashboard error:', error);
        appDiv.innerHTML = `
          <div class="error-screen">
            <h1>ã‚¨ãƒ©ãƒ¼</h1>
            <p>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</p>
            <button onclick="window.location.reload()" class="btn btn-primary">
              å†èª­ã¿è¾¼ã¿
            </button>
          </div>
        `;
      }
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize Supabase
        const client = initSupabase();
        if (!client) {
          throw new Error('Supabase initialization failed');
        }
        
        // Check authentication
        const user = await getCurrentUser();
        if (!user) {
          window.location.href = '/auth-demo.html?returnUrl=' + encodeURIComponent(window.location.href);
          return;
        }
        
        // Hide loading
        document.getElementById('loading').style.display = 'none';
        
        // Show dashboard
        await showDashboard();
        
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').innerHTML = `
          <div class="error-screen">
            <h1>ã‚¨ãƒ©ãƒ¼</h1>
            <p>åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
            <button onclick="window.location.href='/auth-demo.html'" class="btn btn-primary">
              ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
            </button>
          </div>
        `;
      }
    });
  </script>
</body>
</html>
